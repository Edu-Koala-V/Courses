# 5.6: ModularnoÅ›Ä‡ i dynamiczna praca z danymi
## Wprowadzenie

WyobraÅº sobie, Å¼e piszesz skrypty **BATCH** juÅ¼ od jakiegoÅ› czasu. Twoje skrypty dziaÅ‚ajÄ…, ale masz problem: wszystko jest upchniÄ™te w jednym pliku `.bat`, ktÃ³ry wyglÄ…da jak Å›ciana tekstu. Kod staje siÄ™ trudny do zrozumienia, poprawiania i rozwijania. Brzmi znajomo?

RozwiÄ…zaniem powyÅ¼szej rozterki bÄ™dzie zastosowanie **modularnoÅ›ci**, **obiektowego myÅ›lenia** oraz rozdzielanie logiki skryptÃ³w od danych, ktÃ³re naleÅ¼y przechowywaÄ‡ w osobnych plikach.

Zbudujemy prosty system zarzÄ…dzania listÄ… zadaÅ„ (**todo list**), ktÃ³ry pokaÅ¼e, jak myÅ›leÄ‡ obiektowo i tworzyÄ‡ profesjonalne skrypty.  
_**Gotowy na level up?**_ ğŸ’ªğŸ˜/ğŸ¦¾ğŸ¨

## Definicje

<div data-hint="info">

**ModularnoÅ›Ä‡**: Dzielenie skryptu na mniejsze, niezaleÅ¼ne pliki `.bat`, z ktÃ³rych kaÅ¼dy odpowiada za jednÄ… funkcjÄ™ (np. zapis, odczyt). DziÄ™ki temu kod jest czytelniejszy, Å‚atwiejszy do lokalizowania i naprawiania bÅ‚Ä™dÃ³w oraz moÅ¼na go ponownie uÅ¼ywaÄ‡ w innych projektach.

</div>

<div data-hint="info">

**Obiektowe myÅ›lenie**: Organizowanie kodu wokÃ³Å‚ "*obiektÃ³w*" (np. plik `imiona.txt` jako baza danych) i operacji na nich (np. dodawanie, filtrowanie).  
W **BATCH** obiektem moÅ¼e byÄ‡ plik tekstowy, a moduÅ‚y (pliki `.bat`) sÅ‚uÅ¼Ä… jako metody operujÄ…ce na tym obiekcie.

</div>

## WywoÅ‚ywanie innych skryptÃ³w

PiszÄ…c dany skrypt, moÅ¼esz wyekstrahowaÄ‡ (wyodrÄ™bniÄ‡) fragment kodu do zewnÄ™trznego pliku `.bat`.  
Aby wywoÅ‚aÄ‡ drugi plik w swoim kodzie, uÅ¼yj instrukcji `CALL lokalizacja/nazwa_pliku.bat`. JeÅ¼eli plik jest w tym samym katalogu co gÅ‚Ã³wny skrypt, wystarczy podaÄ‡ tylko jego nazwÄ™.

Dla przykÅ‚adu napiszmy mega prosty skrypt witajÄ…cy uÅ¼ytkownika.

```dos
@echo off
CHCP 65001>nul

set /p imie="Podaj swoje imiÄ™: "

echo Witaj, %imie%!

pause
```

Wynik tego skryptu jest nastÄ™pujÄ…cy:

![Wynik skryptu witaj.bat](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/batch-obj-witaj.webp)

Teraz przepiszmy go na strukturÄ™ modularnÄ…/obiektowÄ….

Najpierw przygotujmy strukturÄ™ naszego mini projektu:

```dos
tree /f
Folder PATH listing for volume VBOX_PrzestrzeÅ„_sieciowa
Volume serial number is EAE5-2A9D
Z:.
â”‚   main.bat
â”‚
â””â”€â”€â”€core
        witaj.bat
```

Jak widzisz w poniÅ¼szym kodzie, zmieniÅ‚a siÄ™ linia `echo Witaj, %imie%!`. DodaÅ‚em komentarz i z pomocÄ… instrukcji `CALL` wywoÅ‚am skrypt **BATCH** znajdujÄ…cy siÄ™ w katalogu `core`, przesyÅ‚ajÄ…c mu zmiennÄ… jako parametr.

<small>main.bat</small>

```dos
@echo off
CHCP 65001>nul

set /p imie="Podaj swoje imiÄ™: "

rem WywoÅ‚anie pliku witaj.bat z lokalizacji wzglÄ™dnej wysyÅ‚ajÄ…c dane z zmiennej jako parametr
call core\witaj.bat %imie%

pause
```

Gdy uruchomisz powyÅ¼szy skrypt i nie bÄ™dziesz mieÄ‡ w katalogu `core` pliku `witaj.bat`, zobaczysz poniÅ¼szy komunikat:

```dos
'core' is not recognized as an internal or external command,
operable program or batch file.
```

Teraz przejdÅºmy do napisania skryptu `witaj.bat`. PamiÄ™tajÄ…c, Å¼e przesyÅ‚amy do niego parametr, zawartoÅ›Ä‡ bÄ™dzie nastÄ™pujÄ…ca:

<small>core/witaj.bat</small>

```dos
echo Witaj, %1! MiÅ‚y mamy dziÅ› dzieÅ„ ğŸ˜
```

Jak moÅ¼esz zauwaÅ¼yÄ‡, w tym skrypcie nie zastosowaÅ‚em `@echo off`, `CHCP 65001>nul` i `pause`. PoniewaÅ¼ nie muszÄ™. MoÅ¼esz sobie wyobraziÄ‡, Å¼e gdy uruchamiasz `main.bat`, to w linii, gdzie uÅ¼yto `CALL` do innego skryptu, konsola **CMD** wstawi w to miejsce zawartoÅ›Ä‡ tego wskazanego pliku.


## Zapisywanie danych do pliku

Zapisywanie do pliku pamiÄ™tasz pewnie z moduÅ‚u 4. JeÅ›li nie, to skÅ‚adnia jest nastÄ™pujÄ…ca:

```dos
echo treÅ›Ä‡ > plik.txt
```

Wykorzystajmy ten powyÅ¼szy strumieÅ„ danych, ale nie nadpisujmy zawartoÅ›ci, uÅ¼ywajÄ…c `>`, a dopiszmy na koniec, uÅ¼ywajÄ…c `>>`.

Nasz nowy skrypt w `core` o nazwie `zapis.bat` bÄ™dzie miaÅ‚ nastÄ™pujÄ…cÄ… skÅ‚adniÄ™:

<small>core/zapis.bat</small>

```dos
echo %1>>test.txt
echo Zapisano do test.txt
```

Zmodyfikuj takÅ¼e gÅ‚Ã³wny `main.bat`, aby wywoÅ‚aÄ‡ nowy skrypt i jako parametr przeÅ›lij zmiennÄ… `%imie%`.  
Teraz uruchom `main.bat` i znajdÅº plik `test.txt`.

Nigdzie go nie ma? A odÅ›wieÅ¼ <img src="https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/file-explorer-icon.png" alt="File Explorer Icon" style="display: inline-block; height: 1.2rem; vertical-align: middle;"> *Eksplorator plikÃ³w*, w ktÃ³rym jest plik `main.bat`. No i co? ZnalazÅ‚ siÄ™ plik?

Zmodyfikuj wiÄ™c plik `zapis.bat`: `echo %1>>dane\test.txt`. Czy teraz dziaÅ‚a?

OtÃ³Å¼ tym razem nie dziaÅ‚a, bo katalog `dane` nie istnieje. Zabezpieczmy siÄ™ przed tym.  
PamiÄ™tasz, jakÄ… instrukcjÄ… sprawdzaÄ‡, czy katalog lub plik istnieje?

<span class="secret-link">[Dobrze Laura](https://www.youtube.com/watch?v=-Qtf8exmD0A)</span>, wiÄ™c zmodyfikujmy `zapis.bat`, aby juÅ¼ ostatecznie dziaÅ‚aÅ‚ jak naleÅ¼y, i zmieÅ„my nazwÄ™ pliku na bardziej adekwatnÄ…, np. `imiona.txt`.

<small>core/zapis.bat</small>

```dos
rem SprawdÅº, czy katalog dane nie istnieje i wtedy go stwÃ³rz.
if not exist dane (md dane)

rem Dopisz do pliku imiona.txt przesÅ‚anÄ… zawartoÅ›Ä‡ parametru, a jeÅ¼eli plik nie istnieje, to go najpierw stwÃ³rz.
echo %1>>dane\imiona.txt

rem WyÅ›wietl komunikat o udanym zapisie.
echo Dane zostaÅ‚y zapisane.
```


## Odczyt danych z pliku

Skoro mamy juÅ¼ zapisywanie imienia do pliku `dane/imiona.txt`, to sprÃ³bujmy je odczytaÄ‡.  
BÄ™dzie to bardzo proste, bo wystarczy uÅ¼yÄ‡ komendy `type` i wskazaÄ‡ plik.

<small>core/odczyt.bat</small>

```dos
type dane\imiona.txt
```

Teraz nasz skrypt daje nastÄ™pujÄ…cy wynik:

![Dodanie imienia i wyÅ›wietlenie wszystkich imion z pliku dane/imiona.txt.](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/batch-view-all.webp)


### Odczyt przefiltrowanych danych z pliku

Odczyt okazaÅ‚ siÄ™ bardzo prosty. Napiszmy kolejny moduÅ‚, ktÃ³ry z pliku `imiona.txt` bÄ™dzie nam wyÅ›wietlaÅ‚ tylko mÄ™skie lub tylko Å¼eÅ„skie imiona.  
W jÄ™zyku polskim moÅ¼na je bardzo Å‚atwo odrÃ³Å¼niÄ‡. Å»eÅ„skie imiona zawsze koÅ„czÄ… siÄ™ literÄ… `a`.  
W **CMD** do filtrowania, a bardziej wyszukiwania stosuje siÄ™ komendÄ™ `findstr`.  
PoniÅ¼ej przedstawiam Ci tabelÄ™ z metaznakami, ktÃ³re bardzo uÅ‚atwiÄ… Ci pracÄ™:

| **Cel wyszukiwania** | **Opis** | **PrzykÅ‚ad polecenia** | **Uwagi** |
|:------------------------------------------|:-------------------------------------------------------|:------------------------------------|:------------------------------------------------------------------------|
| **Zawiera danÄ… literÄ™** | Szuka linii zawierajÄ…cych konkretnÄ… literÄ™.            | `findstr a plik.txt`                | Wyszuka linie zawierajÄ…ce literÄ™ `a`.                                     |
| **Zawiera dane sÅ‚owo** | Szuka linii zawierajÄ…cych dokÅ‚adne sÅ‚owo.              | `findstr "kot" plik.txt`            | Wyszuka linie zawierajÄ…ce sÅ‚owo `kot` (np. "kot", "koty", "kotem").     |
| **Zaczyna siÄ™ od litery/sÅ‚owa** | Szuka linii zaczynajÄ…cych siÄ™ od danego ciÄ…gu.         | `findstr /I "^a" plik.txt`          | `^` oznacza poczÄ…tek linii.                                               |
| **KoÅ„czy siÄ™ na literÄ™/sÅ‚owo** | Szuka linii koÅ„czÄ…cych siÄ™ danÄ… literÄ… lub sÅ‚owem.     | `findstr /I "a$" plik.txt`          | `$` oznacza koniec linii.                                                 |
| **Zawiera dokÅ‚adne sÅ‚owo** | Szuka sÅ‚owa jako osobnego wyrazu.                      | `findstr /I "\<kot\>" plik.txt`     | `\<` i `\>` oznaczajÄ… granice sÅ‚owa.                                      |
| **Wiele sÅ‚Ã³w jednoczeÅ›nie** | Szuka linii zawierajÄ…cych dowolne z podanych sÅ‚Ã³w.     | `findstr "kot pies" plik.txt`       | Znajdzie linie zawierajÄ…ce `kot` **lub** `pies`.                          |

Struktura polecenia `findstr` jest nastÄ™pujÄ…ca:

`findstr [opcje] [filtr] [plik]`

Filtry sÄ… zamieszczone w powyÅ¼szej tabeli. Dodatkowo moÅ¼esz dodaÄ‡ opcjÄ™ `/I`, aby ignorowaÄ‡ wielkoÅ›Ä‡ liter w wyszukiwaniu.

WiÄ™c, aby przefiltrowaÄ‡ i wyÅ›wietliÄ‡ tylko Å¼eÅ„skie imiona, napiszemy nastÄ™pujÄ…cy moduÅ‚ filtrujÄ…cy:

<small>core\\filtrowanie.bat</small>

```dos
findstr /I "a$" dane\imiona.txt
```

![Filtrowanie Å¼eÅ„skich imion](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/batch-names-women.webp)

ChcÄ…c teraz wyÅ›wietliÄ‡ tylko mÄ™skie imiona, wystarczy dodaÄ‡ opcjÄ™ `/V` do wyÅ›wietlenia linii, ktÃ³re sÄ… niezgodne z filtrem, czyli wyraÅ¼eniem regularnym.

<div data-hint="danger">

W wyraÅ¼eniach regularnych `findstr` metaznak `$` oznacza **koniec linii**. NaleÅ¼y jednak pamiÄ™taÄ‡, Å¼e `findstr` nie traktuje znaku koÅ„ca pliku (`\0`) jako `\n`. W zwiÄ…zku z tym, jeÅ›li ostatnie imiÄ™ w pliku nie ma po sobie znaku nowej linii, `$`(`\n`) wiÄ™c filtrowanie `a$` zwrÃ³ci niepoprawny wynik dla tego wiersza.

Z kolei metaznak `\>` oznacza **koniec sÅ‚owa**. Jest to znacznie pewniejsze rozwiÄ…zanie. 

UÅ¼ycie `"a\>"` pozwala `findstr` znaleÅºÄ‡ wszystkie sÅ‚owa koÅ„czÄ…ce siÄ™ na literÄ™ `a`, niezaleÅ¼nie od tego, czy po nich sÄ… spacje, czy jest to ostatni element w pliku bez znaku nowej linii.

</div>

## Aktualizacja danych

Zaktualizujmy dane w pliku `imiona.txt`, aby kaÅ¼da linia byÅ‚a ponumerowana.  
Aby tego dokonaÄ‡, wykorzystamy dobrze juÅ¼ Ci znanÄ… instrukcjÄ™ iteracyjnÄ…, czyli pÄ™tlÄ™ i strumieniowanie danych.

Na poczÄ…tku naleÅ¼y dodaÄ‡ instrukcjÄ™ `setlocal enabledelayedexpansion`, aby mÃ³c korzystaÄ‡ ze zmiennych w pÄ™tli `for`.

Teraz bÄ™dziemy analizowaÄ‡ linie oryginalnego pliku `imiona.txt` i wynik modyfikacji danej linii dopisywaÄ‡ do tymczasowego pliku `tmp_imiona.txt`. Z racji, Å¼e bÄ™dziemy chcieli skorzystaÄ‡ z pÄ™tli do czytania linii w pliku, potrzebujemy zmiennej, ktÃ³ra posÅ‚uÅ¼y nam za licznik linii. W efekcie koÅ„cowym musimy przygotowaÄ‡ taki zestaw zmiennych:

```dos
set "plik=dane\imiona.txt"
set "tymczasowy=dane\tmp_imiona.txt"
set /a licznik=1
```

Dobrze, to teraz, wykorzystujÄ…c `>` strumieniowanie danych, bÄ™dziemy przesyÅ‚aÄ‡ wynik `echo` z pÄ™tli:

```dos
> %tymczasowy% (
    for /f "delims=" %%l in (%plik%) do (
        echo !licznik!. ^| %%l
        set /a licznik+=1
    )
)
```

  - `> %tymczasowy% (...)`: przekierowuje strumieÅ„ danych z zawartoÅ›ci nawiasÃ³w `(...)` do pliku. W tym przypadku zmienna `%tymczasowy%` ma w sobie lokalizacjÄ™ wzglÄ™dnÄ… do pliku: `dane/tmp_imiona.txt`.
  
  - `for /f "delims=" %%l in (%plik%) do (...)`: pÄ™tla dziaÅ‚ajÄ…ca na pliku `/F`, poruszajÄ…ca siÄ™ po liniach (`"delims="`) i zapisujÄ…ca je do zmiennej iteracyjnej `%%l` (`in (lokalizacja pliku)`).
  - `echo !licznik!. ^| %%l`: wyÅ›wietla komunikat w strumieniu wyjÅ›cia, podajÄ…c wartoÅ›Ä‡ zmiennej `!licznik!`, dopisujÄ…c `. |` oraz wczeÅ›niejszÄ… zawartoÅ›Ä‡ linii `%%l`.  
  Zapis `^|` pozwala traktowaÄ‡ `|` jako zwykÅ‚y znak.
  - `set /a licznik+=1`: ustawia nowÄ… wartoÅ›Ä‡ licznika, wiÄ™kszÄ… o $$1$$.

Kod, ktÃ³ry zapisaliÅ›my, utworzyÅ‚ nowy plik tymczasowy z gotowym formatowaniem. WiÄ™c przy pomocy `move` nadpiszemy tym plikiem stary plik.

```dos
move /Y "%tymczasowy%" "%plik%"
```

<div data-hint="warning">

Zmienne muszÄ… byÄ‡ w cudzysÅ‚owie.

</div>

ModuÅ‚ do zaktualizowania pliku `imiona.txt` jest nastÄ™pujÄ…cy:

```dos
setlocal enabledelayedexpansion

set "plik=dane\imiona.txt"
set "tymczasowy=dane\tmp_imiona.txt"
set /a licznik=1

> %tymczasowy% (
    for /f "delims=" %%linia in (%plik%) do (
        echo !licznik!. ^| %%linia
        set /a licznik+=1
    )
)

move /Y "%tymczasowy%" "%plik%"
echo Numeracja zakoÅ„czona.
```

-----

## Projekt listy rzeczy do zrobienia (TO DO)

Tym moduÅ‚em wprowadziÅ‚em CiÄ™ do tworzenia skryptÃ³w **BATCH**. Teraz chcÄ™ Ci zaproponowaÄ‡ wyzwanie napisania w sposÃ³b obiektowy klasycznego **TO DO**.

Oto Twoje menu gÅ‚Ã³wne z opcjami do napisania jako zewnÄ™trzne moduÅ‚y:

```dos
System zarzÄ…dzania zadaniami
=============================
1. Dodaj zadanie
2. WyÅ›wietl zadania
3. UsuÅ„ zadanie
4. Aktualizuj zadanie
5. Wyszukaj zadanie
6. UsuÅ„ wszystkie zadania
7. WyjdÅº
=============================
Wybierz opcjÄ™ (1-7):
```

-----

***Powodzenia!!!*** ğŸ’ªğŸ˜/ğŸ¦¾ğŸ¨

-----

# Podcast AI

<audio src="https://raw.githubusercontent.com/Edu-Koala-V/audio_podcast/refs/heads/main/Windows_11/Audio/Batch Scripting_ Modularity and Data Handling.wav" controls>
Twoja przeglÄ…darka nie wspiera odtwarzania plikÃ³w audio.
</audio>