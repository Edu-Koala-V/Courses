# 6.11.1 Usuwanie plik贸w z logowaniem

## Wprowadzenie

Usuwanie starych plik贸w, np. z folderu `C:\Windows\Temp`, to typowe zadanie administracyjne, kt贸re pozwala zwolni miejsce na dysku.  
Napiszesz skrypt _**PowerShell**_ do usuwania plik贸w starszych ni偶 podana liczba dni, z zapisem logowania operacji do pliku `.log`.

<div data-hint="danger">

### UWAGA!!!

Cay czas korzystae z `Write-Output` do wywietlania komunikat贸w. Zamiast tego zdecydowanie zalecam wykorzystanie `Write-Host` poniewa偶 komunikat, kt贸ry wywietlisz nie zostanie dodany do strumienia wyjcia.  
Pozwoli ci to na uniknicie sytuacji gdy warto np. liczba nagle stanie si tablic. 

</div>

---

## Definicje

<div data-hint="info">

**Statyczne typowanie**: Okrelenie typu danych parametru w funkcji (np. `[string]`, `[int]`), co wymusza poprawny typ i zapobiega bdom.

</div>

<div data-hint="info">

**Waciwo obiektu**: Dane powizane z obiektem, np. `$_.LastWriteTime` to data ostatniej modyfikacji pliku, zwracana przez `Get-ChildItem`.

</div>

---

## Podstawowa skadnia

| Polecenie/Element  | Opis                                                                            |
| :----------------- | :------------------------------------------------------------------------------ |
| `Get-ChildItem`    | Pobiera list plik贸w i folder贸w z podanej cie偶ki.                              |
| `Remove-Item`      | Usuwa pliki lub foldery.                                                        |
| `Out-File`         | Zapisuje tekst do pliku, np. logu.                                              |
| `Test-Path`        | Sprawdza, czy cie偶ka istnieje.                                                 |
| `.`                | Importuje kod z pliku `.ps1`.                                                   |
| `$_.LastWriteTime` | Waciwo obiektu pliku, zwracajca dat ostatniej modyfikacji (`[datetime]`). |
| `[string]`         | Typ danych: cig znak贸w, np. `"30% soku w nektarze"`.                           |
| `[int]`            | Typ danych: liczba cakowita, np. `2137`.                                       |

---

### Tabela typ贸w danych w PowerShell

| Typ          | Opis                  | Przykad                                                               |
| :----------- | :-------------------- | :--------------------------------------------------------------------- |
| `[string]`   | Cig znak贸w (tekst).  | `"Ala ma kota"`                                                        |
| `[int]`      | Liczba cakowita.     | `3`                                                                    |
| `[datetime]` | Data i czas.          | `roda, 27 sierpnia 2025 15:52:34` zwracane przez polecenie `Get-Date` |
| `[array]`    | Lista element贸w.      | `@"Adam", "Ewa"`                                                       |
| `[bool]`     | Warto prawda/fasz. | `$true`, `$false`                                                      |

---

## Przykad: Skrypt usuwajcy pliki z logowaniem

Poni偶szy kod usuwa pliki starsze ni偶 $$30$$ dni z folderu `C:\Windows\Temp` i zapisuje log operacji do `C:\Logs\CleanTemp.log`.  
Funkcje `Write-Log` i `Remove-OldFiles` s w osobnym pliku `CleanupFunctions.ps1`.

### Skrypt logowania operacji

Poni偶ej znajduje si funkcja `Write-Log`, kt贸ra przyjmuje $$2$$ parametry: 
- Cig znak贸w z wiadomoci do zapisania.
- Lokalizacj pliku `.log` do zmodyfikowania (je偶eli istnieje). 

`Write-Output` wypisuje log w formacie daty i treci wiadomoci, a nastpnie zapisuje j na kocu pliku `.log`.

```powershell
function Write-Log {
    param (
        [string]$Message,
        [string]$LogFile
    )
    # Przekierowujemy strumie Write-Output na koniec zawartoci pliku
    Write-Output "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'): $Message" | Out-File -FilePath $LogFile -Append
}
```

### Skrypt usuwajcy starsze ni偶 30 dni pliki i katalogi

```powershell
function Remove-OldFiles {
    param (
        [string]$FolderPath,
        [int]$Days,
        [string]$LogFile
    )
    try {

        # Sprawdzenie, czy podana lokalizacja folderu faktycznie istnieje i zwr贸cenie bdu, gdy nie.
        if (-not (Test-Path $FolderPath)) { throw "Folder nie istnieje!" }

        # Przygotowanie kolekcji element贸w i przefiltrowanie ich na podstawie ostatniej daty modyfikacji
        # je偶eli jest mniejsza ni偶 liczba z parametru $Days
        # Mo偶esz te偶 zauwa偶y, 偶e po "|" daem enter, poniewa偶 w PowerShell biae znaki, jak nadmiarowe spacje, tabulacje czy nowe linie, nie maj znaczenia.
        $resources = Get-ChildItem -Path $FolderPath -ErrorAction Stop |
                Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-$Days) }

        $count = 0 # Licznik plik贸w

        foreach ($res in $resources) {

            # Usunicie pliku lub katalogu oraz rekursywne usuwanie zawartoci katalog贸w dziki dodaniu `-Recurse`
            Remove-Item -Path $res.FullName -Force -Recurse -ErrorAction Stop

            # Zapisanie w logach raportu, co usunito
            Write-Log -Message "Usunito $($res.FullName)" -LogFile $LogFile
            $count++
        }

        # Zapisanie w logach, ile plik贸w z danego katalogu usunito
        Write-Log -Message "Usunito $count plik贸w z $FolderPath" -LogFile $LogFile
    }
    catch {
        # Zapisanie w logach bd贸w, kt贸re wystpiy
        Write-Log -Message "Bd: $($_.Exception.Message)" -LogFile $LogFile
    }
}
```

### Przykad u偶ycia funkcji `Remove-OldFiles`

```powershell
# Importowanie kodu i uruchomienie tych fragment贸w, kt贸re nie s w funkcjach
. "C:\Scripts\CleanupFunctions.ps1"

# Utworzenie nowego katalogu "C:\Logs\", je偶eli ju偶 istnieje to `-Force` nie zgosi bdu a `| Out-Null` nie zwr贸ci komunikatu.
New-Item -Path "C:\Logs" -ItemType Directory -Force | Out-Null
# Uruchomienie funkcji `Remove-OldFiles` i przekazanie do niej parametr贸w.
Remove-OldFiles -FolderPath "C:\Windows\Temp" -Days 30 -LogFile "C:\Logs\CleanTemp.log"
# Opcjonalne oczekiwanie na wcinicie Enter, by zamkn konsol. Mo偶na nie pisa.
Read-Host "Wcinij Enter aby zakoczy dziaanie."
```

---

# Podcast AI

<audio src="https://raw.githubusercontent.com/Edu-Koala-V/audio_podcast/refs/heads/main/Windows_11/Audio/PowerShell File Cleanup with Logging.wav" controls>
Twoja przegldarka nie wspiera odtwarzania plik贸w audio.
</audio>
