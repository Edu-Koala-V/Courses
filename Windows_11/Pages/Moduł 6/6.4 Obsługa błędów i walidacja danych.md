# 6.4 Obsługa błędów i walidacja danych

## Wprowadzenie

_**PowerShell**_ pozwala na niezawodną obsługę błędów za pomocą struktury `try-catch` oraz instrukcji `throw`. Walidacja danych i przechwytywanie błędów zwiększa stabilność skryptów, zapobiegając ich krytycznym przerwaniom i wyświetla czytelne komunikaty.

## Definicja

<div data-hint="info">

**Obsługa błędów**: Mechanizm, który pozwala na przechwytywanie błędów w kodzie i wykonywanie odpowiednich akcji w odpowiedzi na nie, np. wyświetlenie komunikatu.

</div>


## Podstawowa składnia

| Element | Opis | Przykład |
|:---|:---|:---|
| `try` | Blok kodu, który wykonujesz, a który może wywołać błąd. | `try { Get-LocalUser -Name "Janek" }` |
| `catch` | Blok kodu, który przechwytuje błąd z bloku `try` i wykonuje kod w odpowiedzi. | `catch { Write-Output "Błąd: $($_.Exception.Message)" }` |
| `throw` | Tworzy i "rzuca" własny, terminujący błąd z niestandardowym komunikatem. | `throw "Niepoprawne dane!"` |
| `Write-Error` | Wypisuje komunikat jako kategorię błędu, ale nie przerywa działania skryptu. | `Write-Error "Błąd: $($_.Exception.Message)"` |


## Przykład: Wywołanie własnego błędu

Poniższy kod pokazuje, jak ręcznie wywołać błąd za pomocą `throw` i przechwycić go w bloku `catch`.

```powershell
try {
    throw "Wywołanie własnego błędu"
}
catch {
    Write-Error "Błąd: $($_.Exception.Message)"
}

Read-Host "Wciśnij Enter aby zakończyć działanie."
```

![Przykład wywołania własnego błędu](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/try-catch-error-throw.webp)

### Wyjaśnienie `$($_.Exception.Message)`

W bloku `catch` **PowerShell** automatycznie tworzy specjalną, automatyczną zmienną `$_.` Jest to skrót od `$PSItem` i oznacza **bieżący obiekt błędu**.

Kiedy wystąpi błąd w bloku `try` i zostanie on przechwycony przez `catch`, wszystkie informacje o tym błędzie są przechowywane właśnie w `$_.`.

- `$_.Exception`: To właściwość obiektu błędu, która zawiera szczegółowe informacje na temat wyjątku, który wystąpił.
- `.Message`: To właściwość obiektu `Exception`, która przechowuje samą wiadomość błędu w formie tekstowej.
- `$()`: To tzw. podwyrażenie (subexpression), które pozwala na wykonanie polecenia wewnątrz ciągu znaków. Dzięki niemu, `PowerShell` najpierw wykonuje kod w nawiasach, a potem wstawia jego wynik do komunikatu `Write-Output`.

### Rodzaje błędów

- **Błędy nieterminujące**: Domyślny typ błędu w _**PowerShell**_. Nie zatrzymują one działania skryptu, a jedynie wyświetlają komunikat w konsoli.
- **Błędy terminujące**: Zatrzymują wykonanie skryptu w miejscu ich wystąpienia.
- **Błędy własne**: Błędy terminujące, które są tworzone i "rzucane" przez programistę za pomocą `throw` dla niestandardowych przypadków.


## Przykład: Walidacja danych

Poniższy skrypt pokazuje, jak użyć `throw` do walidacji danych wejściowych w funkcji. Jeśli użytkownik wprowadzi nieprawidłowe dane, zostanie wyrzucony błąd, który przechwyci blok `catch`.

```powershell
function Show-Welcome {
    param($imie)
    if (-not $imie) {
        throw "Nie podano imienia!"
    }
    elseif ($imie -match "\d") {
        throw "Imię nie może zawierać liczb!"
    }
    elseif(-not ($imie -match "^[a-zA-Z\s]+$")) {
        throw "Imię może składać się tylko z liter i spacji. Nie używaj cyfr ani znaków specjalnych!"
    }
    Write-Output "Cześć, $imie!"
}

try {
    $imie = Read-Host "Podaj swoje imię"
    Show-Welcome -imie $imie
}
catch {
    Write-Output "Błąd: $($_.Exception.Message)"
}
Read-Host "Wciśnij Enter aby zakończyć działanie."
```


<div data-hint="success">

`-match "\d"`: sprawdza, czy w zmiennej są cyfry (`\d` od *decimal*).
`-match "^[a-zA-Z\s]+$"`: sprawdza, czy w zmiennej znajdują się tylko litery (zarówno małe, jak i duże) oraz spacje.

</div>


## Przykład: Błędy systemowe

Standardowe błędy generowane przez _**PowerShell**_ są domyślnie nieterminujące i nie są przechwytywane przez `catch`. Aby to zmienić, należy dodać parametr `-ErrorAction Stop`, który przekształca błąd nieterminujący w terminujący.

```powershell
function Test-LocalUser {
    param($nazwa)
    try {
        $user = Get-LocalUser -Name $nazwa -ErrorAction Stop
        Write-Output "Użytkownik $nazwa istnieje!"
    }
    catch {
        Write-Output "Błąd systemowy: $($_.Exception.Message)"
    }
}

$nazwa = Read-Host "Podaj nazwę użytkownika"
Test-LocalUser -nazwa $nazwa
Read-Host "Wciśnij Enter aby zakończyć działanie."
```

Poniżej widzisz, jak zmienia się zachowanie skryptu z i bez parametru `-ErrorAction Stop`.

![Błąd systemowy Get-LocalUser](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/try-catch-error-terminujący.webp)

---

# Podcast AI

<audio src="https://raw.githubusercontent.com/Edu-Koala-V/audio_podcast/refs/heads/main/Windows_11/Audio/PowerShell Error Handling and Data Validation.wav" controls>
Twoja przeglądarka nie wspiera odtwarzania plików audio.
</audio>