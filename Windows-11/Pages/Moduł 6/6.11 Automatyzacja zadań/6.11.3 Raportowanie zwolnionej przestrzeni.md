# 6.11.3: Raportowanie zwolnionej przestrzeni

## Wprowadzenie

Dobrze, mam ju偶 funkcjonalno usuwania przestarzaych plik贸w i katalog贸w z podanych w pliku tekstowym lokalizacji. Dodajmy teraz fajny bajer, kt贸ry wywietli nam okienko z informacj, 偶e zakoczono czyszczenie i zwolniono nastpujc ilo miejsca na dysku.

## Modyfikacja funkcji `Remove-OldFiles`

Aby raportowa zwolnione miejsce, zmodyfikujemy funkcj `Remove-OldFiles` (z pliku `CleanupFunctions.ps1`) tak, aby ledzia rozmiar usuwanych plik贸w i zwracaa sum zwolnionego miejsca w bajtach. Nastpnie wykorzystamy t warto w g贸wnym skrypcie.

Oto zaktualizowana funkcja `Remove-OldFiles`:

```powershell
$count = 0        # Licznik usunitych plik贸w
$totalSize = 0    # Suma rozmiaru usunitych plik贸w w bajtach

foreach ($res in $resources) {

    # Obliczenie rozmiaru katalogu/pliku przed usuniciem
    if ($res.PSIsContainer) {
        # Dla folder贸w: sumujemy rozmiar wszystkich plik贸w w folderze
        $size = (Get-ChildItem -Path $res.FullName -Recurse -File -ErrorAction SilentlyContinue |
                Measure-Object -Property Length -Sum -ErrorAction SilentlyContinue).Sum
    } else {
        # Dla pojedynczych plik贸w
        $size = $res.Length
    }

    # Usunicie pliku lub katalogu
    Remove-Item -Path $res.FullName -Force -ErrorAction Stop

    # Zapisanie w logach raportu co usunito
    Write-Log -Message "Usunito $($res.FullName) (Rozmiar: $([math]::Round($size / 1MB, 2)) MB)" -LogFile $LogFile
    $count++
    $totalSize += $size
}

# Zapisanie w logach ile plik贸w z danego katalogu usunito i ile miejsca zwolniono
Write-Log -Message "Usunito $count plik贸w z $FolderPath. Zwolniono $([math]::Round($totalSize / 1MB, 2)) MB" -LogFile $LogFile

# Zwr贸cenie zwolnionego miejsca w bajtach
return $totalSize
```

**Zmiany w funkcji**:

  - Dodano zmienn `$totalSize` do ledzenia sumy rozmiaru usuwanych plik贸w/folder贸w.
  - Dla ka偶dego zasobu (`$res`):
      - Jeli jest to plik, rozmiar pobieramy z waciwoci `$res.Length`.
      - Jeli jest to folder, u偶ywamy `Get-ChildItem -Recurse -File` i `Measure-Object` do sumowania rozmiaru wszystkich plik贸w w folderze.
  - Rozmiar jest logowany w megabajtach (po konwersji z bajt贸w za pomoc `[math]::Round($size / 1MB, 2)`).
      - `$size` to zmienna zawierajca rozmiar w bajtach. $$1 MB$$ to skr贸t PowerShella przeliczajcy **$$1 \phantom{0}megabajt = 1 \phantom{0}048 \phantom{0}576 \phantom{0}bajt贸w$$**.
      - `[math]::Round(..., 2)`
          - `[math]` to klasa matematyczna z **.NET**.
          - `Round(X, 2)` zaokrgla liczb $$X$$ do $$2$$ miejsc po przecinku.
  - Funkcja zwraca `return $totalSize` (w bajtach), aby g贸wny skrypt m贸g sumowa zwolnione miejsce dla wszystkich lokalizacji.

## Modyfikacja g贸wnego skryptu

Musimy zmodyfikowa nasz *main* skrypt, aby sumowa wartoci zwracane przez funkcj `Remove-OldFiles` oraz dopiszmy linie kodu, kt贸re pozwol na wywietlenie okienka **GUI** z komunikatem.

Aby wywietli okienko systemowe, zaadujemy przestrze nazw `System.Windows.Forms` po sprawdzeniu, czy skrypt uruchomiono jako administrator i u偶yjemy klasy `MessageBox`.

```powershell
# Zaadowanie przestrzeni nazw dla MessageBox
Add-Type -AssemblyName System.Windows.Forms
```

Przygotuj zmienn do sumowania wynik贸w funkcji `Remove-OldFiles` i zainicjuj jej warto na $$0$$, aby unikn przypadku odwoania si do kom贸rki pamici **RAM**, w kt贸rej znajduje si ju偶 jaka liczba.

```powershell
# Zmienna do sumowania zwolnionego miejsca
$totalFreedSpace = 0
```

Zmodyfikuj wywoanie funkcji `Remove-OldFiles` z:

```powershell
    # Wywoanie funkcji Remove-OldFiles dla ka偶dego folderu
    Remove-OldFiles -FolderPath $ExpandedFolder -Days $Days -LogFile $LogFile
```

na:

```powershell
    # Wywoanie funkcji Remove-OldFiles i dodanie wyniku, kt贸ry zwr贸ci do zmiennej $totalFreedSpace
    $totalFreedSpace += Remove-OldFiles -FolderPath $ExpandedFolder -Days $Days -LogFile $LogFile
```

Na koniec dokonaj ponownie konwersji sumy usunitych zasob贸w do formatu **$$MB$$** i $$2$$ miejsc po przecinku.  
Nastpnie zapisz komunikat z implementacj obliczonej iloci zwolnionego miejsca.

<div data-hint="info">

`\n`: przejcie do nowej linii.

</div>

呕eby wywietli okienko, odwoaj si do klasy systemowej Windowsa z **.NET**.

```powershell
# Konwersja zwolnionego miejsca na MB i zaokrglenie
$totalFreedSpaceMB = [math]::Round($totalFreedSpace / 1MB, 2)

# Zapisanie podsumowania do logu
Write-Log -Message "Czyszczenie zakoczone. cznie zwolniono $totalFreedSpaceMB MB." -LogFile $LogFile

# Wywietlenie okienka systemowego
$Message = "Czyszczenie systemu zakoczone.`nZwolniono $totalFreedSpaceMB MB miejsca na dysku."
[System.Windows.Forms.MessageBox]::Show($Message, "Czyszczenie systemu", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)

Write-Host "Skrypt zakoczy dziaania. "
# Opcjonalne oczekiwanie na Enter
Read-Host "Wcinij Enter, aby zakoczy dziaanie."
```

![Komunikat z oczyszczeniem katalog贸w](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-remove-files-raport.webp)

---

# Podcast AI

<audio src="https://raw.githubusercontent.com/Edu-Koala-V/audio_podcast/refs/heads/main/Windows_11/Audio/Reporting Freed Disk Space in PowerShell.wav" controls>
Twoja przegldarka nie wspiera odtwarzania plik贸w audio.
</audio>