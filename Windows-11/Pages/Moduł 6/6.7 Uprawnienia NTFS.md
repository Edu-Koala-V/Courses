# 6.7 Uprawnienia NTFS

## Wprowadzenie

_**PowerShell**_ zapewnia pen kontrol nad uprawnieniami **`NTFS`**, zastpujc archaiczne polecenia **CMD** (`cacls`, `icacls`) i interfejs graficzny (**GUI**) dostpny w oknie <kbd class="win-menu-btn">Waciwoci</kbd> > <kbd class="win-menu-btn">Zabezpieczenia</kbd>`.  


<div data-hint="info">

Ka偶de uprawnienie jest definiowane w obiekcie **`FileSystemAccessRule`**, kt贸ry szczeg贸owo okrela trzy kluczowe elementy:

  - **to偶samo u偶ytkownika lub grupy**,
  - **poziom dostpu** (np. `FullControl`, `Read`),
  - **typ uprawnienia** (<span class="allowCode">`Allow`</span> - <span style="color:#6ccf6c;">zezw贸l</span>, <span class="denyCode">`Deny`</span> - <span style="color:#ff6060;">odm贸w</span>).

</div>

-----

## Dostpne uprawnienia NTFS

Oto tabela przedstawiajca najczciej u偶ywane uprawnienia **`NTFS`**:

| Uprawnienie | Opis |
| :--- | :--- |
| `FullControl` | Peny dostp: odczyt, uruchamianie, zapis, modyfikacja, usuwanie, a tak偶e zmiana uprawnie. |
| `Modify` | Odczyt, zapis, uruchamianie, modyfikacja i usuwanie. |
| `ReadAndExecute` | Pozwala na odczyt i uruchamianie plik贸w. |
| `Read` | Zapewnia dostp tylko do odczytu. |
| `Write` | Pozwala na zapis i modyfikacj zawartoci. |

<div data-hint="danger">

## Reguy <span class="denyCode">`Deny`</span> maj wikszy priorytet ni偶 <span class="allowCode">`Allow`</span>

_**To bardzo wa偶na zasada!**_  
Jeli u偶ytkownik ma jednoczenie uprawnienie `FullControl` (<span class="allowCode">`Allow`</span>) i `ReadAndExecute` (<span class="denyCode">`Deny`</span>) na tym samym folderze, nie bdzie m贸g odczyta zawartoci ani uruchomi plik贸w.  
Regua <span class="denyCode">`Deny`</span> zawsze ma pierwszestwo i blokuje dostp, nawet jeli uprawnienie <span class="allowCode">`Allow`</span> zostao wczeniej nadane.

</div>


## Dziedziczenie uprawnie

Dziedziczenie w **`NTFS`** pozwala na propagacj uprawnie z folderu nadrzdnego na jego podfoldery i pliki.  
Domylnie, podfoldery i pliki dziedzicz uprawnienia od rodzica, chyba 偶e dziedziczenie zostanie wyczone.

---

### Tabela: Mapowanie opcji GUI na flagi PowerShell

Poni偶ej znajduje si tabela, kt贸ra uatwia zrozumienie, jak opcje z graficznego interfejsu (**GUI**) przekadaj si na parametry `InheritanceFlags` i `PropagationFlags` w _**PowerShell**_.

| **Przedmiot zabezpiecze (GUI)** | **InheritanceFlags** | **PropagationFlags** |
| :--- | :--- | :--- |
| Tylko ten folder | `None` | `None` |
| Ten folder, podfoldery i pliki | `ContainerInherit, ObjectInherit` | `None` |
| Ten folder i podfoldery | `ContainerInherit` | `None` |
| Ten folder i pliki | `ObjectInherit` | `None` |
| Tylko podfoldery i pliki | `ContainerInherit, ObjectInherit` | `InheritOnly` |
| Tylko podfoldery | `ContainerInherit` | `InheritOnly` |
| Tylko pliki | `ObjectInherit` | `InheritOnly` |

![Przedstawienie w GUI zakresu kt贸rego ma dotyczy dziedziczenie uprawnie NTFS](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/ntfs-dziedziczenie-dotyczy.webp)

###  Wczanie dziedziczenia

Aby regua bya dziedziczona, w obiekcie `FileSystemAccessRule` u偶ywa si parametru `InheritanceFlags`.

  - `ContainerInherit`: regua dotyczy podfolder贸w.
  - `ObjectInherit`: regua dotyczy plik贸w.
  - `None` w `PropagationFlags`: regua stosuje si do folderu i jego zawartoci.

**Przykad:**

```powershell
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
```

Pena skadnia obiektu `FileSystemAccessRule` wyglda tak:

```
("u偶ytkownik/grupa", "Uprawnienie", "flaga dziedziczenia", "czy propagacja obejmuje ten folder [None], czy tylko zawarto [InheritOnly]", "typ uprawnienia")
```


###  Wyczanie dziedziczenia

Mo偶esz wyczy dziedziczenie uprawnie z folderu nadrzdnego, u偶ywajc metody `SetAccessRuleProtection`.

<div data-tabs>
<div class="tabs">
<b>PowerShell</b>
<b>Skrypt PS1</b>
</div>
<div class="active">

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$acl.SetAccessRuleProtection($true, $false)
Set-Acl -Path $path -AclObject $acl
```

</div>
<div>

```powershell
try {
    $path = "C:\TestFolder"
    $acl = Get-Acl $path -ErrorAction Stop
    $acl.SetAccessRuleProtection($true, $false) # Wycza dziedziczenie i usuwa dziedziczone reguy
    Set-Acl -Path $path -AclObject $acl -ErrorAction Stop
    Write-Output "Dziedziczenie wyczone dla folderu $path!"
}
catch {
    Write-Output "Bd: $($_.Exception.Message)"
}
Read-Host "Wcinij Enter, by zakoczy."
```

</div>
</div>

  - `$true`: wycza dziedziczenie.
  - `$false`: usuwa dziedziczone reguy (mo偶esz ustawi `$true`, aby je zachowa, przeksztacajc je w lokalne reguy).

## Sprawdzanie uprawnie

U偶yj `Get-Acl`, aby wywietli uprawnienia dla pliku lub folderu.

<div data-tabs>
<div class="tabs">
<b>PowerShell</b>
<b>Skrypt</b>
<b>Dziedziczenie</b>
</div>
<div class="active">

```powershell
Get-Acl -Path "C:\TestFolder" | Format-List
```
![Wynik komendy Get-Acl](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Get-Acl.webp)

Alternatywnie, aby uzyska bardziej zwizy widok uprawnie, mo偶esz u偶y:

```powershell
Get-Acl -Path "C:\TestFolder" | Select-Object -ExpandProperty Access
```

</div>
<div>

```powershell
try {
    $path = "C:\TestFolder"
    $acl = Get-Acl -Path $path -ErrorAction Stop
    Write-Output "Uprawnienia dla $path:"
    $acl.Access | ForEach-Object { Write-Output "$($_.IdentityReference) - $($_.FileSystemRights)" }
}
catch {
    Write-Output "Bd: $($_.Exception.Message)"
}
Read-Host "Wcinij Enter, by zakoczy."
```

![Wynik skryptu](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Get-Acl-script.webp)

</div>
<div>

Mo偶esz atwo filtrowa tylko dziedziczone uprawnienia.

```powershell
Get-Acl -Path "C:\TestFolder" | Select-Object -ExpandProperty Access | Where-Object { $_.IsInherited }
```

</div>
</div>

<div data-hint="danger">

Jeli u偶ytkownik ma uprawnienie `ReadAndExecute` (<span class="denyCode">`Deny`</span>) na folderze, nie bdzie m贸g wej do folderu ani wywietli jego uprawnie za pomoc `Get-Acl`.

</div>


## Ustawianie uprawnie

U偶yj `Set-Acl` i metody `SetAccessRule`, aby zdefiniowa now regu dla zasobu.

<div data-tabs>
<div class="tabs">
<b>PowerShell</b>
<b>Skrypt</b>
<b>Dziedziczenie</b>
</div>
<div class="active">

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "FullControl", "Allow")
$acl.SetAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```
![Wynik komendy Set-Acl](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Set.webp)

</div>
<div>

```powershell
try {
    $path = "C:\TestFolder"
    $acl = Get-Acl $path -ErrorAction Stop
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "ReadAndExecute", "ContainerInherit,ObjectInherit", "None", "Deny")
    $acl.SetAccessRule($rule)
    Set-Acl -Path $path -AclObject $acl -ErrorAction Stop
    Write-Output "Uprawnienia ustawione dla Janka na $path!"
}
catch {
    Write-Output "Bd: $($_.Exception.Message)"
}
Read-Host "Wcinij Enter, by zakoczy."
```
![Wynik skryptu](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Set-script.webp)

</div>
<div>

Ustawia uprawnienia, kt贸re bd dziedziczone.

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$acl.SetAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```

</div>
</div>

<div data-hint="success">

**`SetAccessRule`** nadpisuje istniejce reguy dla danego u偶ytkownika lub grupy. Ustawienie `ContainerInherit` i `ObjectInherit` zapewnia, 偶e regua bdzie dziedziczona przez podfoldery i pliki.

</div>

-----

## Modyfikowanie uprawnie

U偶yj `Set-Acl` z metod `AddAccessRule`, aby doda now regu do istniejcych uprawnie.

<div data-tabs>
<div class="tabs">
<b>PowerShell</b>
<b>Skrypt</b>
<b>Dziedziczenie</b>
</div>
<div class="active">

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "ReadAndExecute", "Deny")
$acl.AddAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```
![Wynik komendy AddAccessRule](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Add.webp)

</div>
<div>

```powershell
try {
    $path = "C:\TestFolder"
    $acl = Get-Acl $path -ErrorAction Stop
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "Write", "Allow")
    $acl.AddAccessRule($rule)
    Set-Acl -Path $path -AclObject $acl -ErrorAction Stop
    Write-Output "Uprawnienia zmodyfikowane dla Janka na $path!"
}
catch {
    Write-Output "Bd: $($_.Exception.Message)"
}
Read-Host "Wcinij Enter, by zakoczy."
```
![Wynik skryptu](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Add-script.webp)

</div>
<div>

Dodaje regu z dziedziczeniem.

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "Write", "ContainerInherit,ObjectInherit", "None", "Allow")
$acl.AddAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```

</div>
</div>

<div data-hint="info">

**`AddAccessRule`** dodaje now regu do istniejcego obiektu `ACL`, nie usuwajc innych uprawnie. W przeciwiestwie do niej, `SetAccessRule` nadpisuje ca regu dla danego u偶ytkownika.

</div>

-----

## Usuwanie uprawnie

U偶yj `Set-Acl` z metod `RemoveAccessRule`, aby usun konkretn regu dostpu.

<div data-tabs>
<div class="tabs">
<b>PowerShell</b>
<b>Skrypt</b>
<b>Dziedziczenie</b>
</div>
<div class="active">

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "FullControl", "Allow")
$acl.RemoveAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```
![Wynik komendy RemoveAccessRule](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Remove.webp)

</div>
<div>

```powershell
try {
    $path = "C:\TestFolder"
    $acl = Get-Acl $path -ErrorAction Stop
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "ReadAndExecute", "Deny")
    $acl.RemoveAccessRule($rule)
    Set-Acl -Path $path -AclObject $acl -ErrorAction Stop
    Write-Output "Uprawnienia usunite dla Janka na $path!"
}
catch {
    Write-Output "Bd: $($_.Exception.Message)"
}
Read-Host "Wcinij Enter, by zakoczy."
```
![Wynik skryptu](https://raw.githubusercontent.com/Edu-Koala-V/images/main/Windows_11/Images/powershell-Acl-Remove-script.webp)

</div>
<div>

Usuwa regu z okrelonymi flagami dziedziczenia.

```powershell
$path = "C:\TestFolder"
$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Janek", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$acl.RemoveAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```

</div>
</div>

<div data-hint="info">

**`RemoveAccessRule`** usuwa konkretn regu dostpu dla u偶ytkownika lub grupy z obiektu `ACL`.

</div>

---

# Podcast AI

<audio src="https://raw.githubusercontent.com/Edu-Koala-V/audio_podcast/refs/heads/main/Windows_11/Audio/NTFS Permissions Management with PowerShell.wav" controls>
Twoja przegldarka nie wspiera odtwarzania plik贸w audio.
</audio>